<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Canopy Manual</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="overview.html"><strong aria-hidden="true">1.</strong> Overview</a></li><li class="chapter-item expanded "><a href="nodes.html"><strong aria-hidden="true">2.</strong> Nodes</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="commands.html"><strong aria-hidden="true">2.1.</strong> Commands</a></li><li class="chapter-item expanded "><a href="layout.html"><strong aria-hidden="true">2.2.</strong> Layout</a></li><li class="chapter-item expanded "><a href="focus.html"><strong aria-hidden="true">2.3.</strong> Focus</a></li><li class="chapter-item expanded "><a href="polling.html"><strong aria-hidden="true">2.4.</strong> Polling</a></li></ol></li><li class="chapter-item expanded "><a href="keybindings.html"><strong aria-hidden="true">3.</strong> Key bindings</a></li><li class="chapter-item expanded "><a href="scripting.html"><strong aria-hidden="true">4.</strong> Scripting</a></li><li class="chapter-item expanded "><a href="widgets.html"><strong aria-hidden="true">5.</strong> Widgets</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Canopy Manual</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="canopy-a-terminal-ui-library-for-rust"><a class="header" href="#canopy-a-terminal-ui-library-for-rust">Canopy: a terminal UI library for Rust</a></h1>
<p>In a forest each tree spreads its branches wide to maximise access to sunlight, but also carefully avoids touching the
foliage of its neighbours. This phenomenon is called &quot;crown shyness&quot; - the forest canopy becomes an organic tiling of
the sky.</p>
<p><strong>Canopy</strong> works just the same, but in your terminal. Interface elements are arranged in an ordered tree, with each node
managing only its children, who manage their own children in turn, until the leaf nodes tile the screen without overlap.
All interface operations are defined cleanly as traversals of this node tree.</p>
<h2 id="concepts"><a class="header" href="#concepts">Concepts</a></h2>
<h3 id="nodes"><a class="header" href="#nodes">Nodes</a></h3>
<h3 id="rendering"><a class="header" href="#rendering">Rendering</a></h3>
<img width=300 style="padding: 20px;" src="assets/rendering.png">
<p>Rust is fast, and terminals are slow. The key to performance is to send as few
operations to the terminal as possible. Canopy uses a mark-and-sweep mechanism
to redraw only what's needed. Nodes that need rendering are tainted using the
<strong>taint</strong> or <strong>taint_tree</strong> functions. Nodes are automatically tainted if they
handle an event or if their focus status changes.</p>
<p>Rendering is a pre-order traversal of the tree with the <strong>render</strong> method called
on each tainted node.</p>
<h3 id="focus"><a class="header" href="#focus">Focus</a></h3>
<img width=300 style="padding: 20px;" src="assets/focus.png">
<p>Eactly one node has <strong>focus</strong> at any one time. If a node has focus, its
ancestors up to the root of the tree are on the <strong>focus path</strong>. A corollary of
this is that the root node is always on the focus path. Nodes advertise whether
they can accept focus by implementing the <strong>can_focus</strong> method of the <strong>Node</strong>
trait - any node can accept focus, even if it's not a leaf.</p>
<p>Canopy provides various functions for controlling the focus in a subtree. These are
usually used from event handlers, letting a node control the focus location in
the subtree below it.</p>
<div>
    <div style="float: left; display: inline-block; padding: 10px;" >
        <img width=250 src="assets/focus-next.png"/>
        <center style="font-weight: bold">focus::next</center>
    </div>
    <div style="display: inline-block; padding: 10px;">
        <img width=250 src="assets/focus-prev.png"/>
        <center style="font-weight: bold">focus::prev</center>
    </div>
</div>
<p>The <strong>focus::next</strong> and <strong>focus::prev</strong> functions set focus to the next and
previous nodes that accept focus in the pre-order traversal of the tree. In the
images above, the grey nodes accept focus, and the red arrow shows where focus
will move with respect to the pre-order traversal.</p>
<div>
    <div style="float: left; display: inline-block; padding: 10px;" >
        <img width=250 src="assets/focus-up.png"/>
        <center style="font-weight: bold">focus::up</center>
    </div>
    <div style="display: inline-block; padding: 10px;" >
        <img width=250 src="assets/focus-right.png"/>
        <center style="font-weight: bold">focus::right</center>
    </div>
</div>
<p>Canopy also has the spatial focus functions <strong>focus::{up,down,left,right}</strong>.
These functions take the screen area of the currently focused node, then search
for nodes that accept focus in the specified direction to choose the new focus.</p>
<p>When a node's focus status changes, it is automatically tainted for rendering in the next sweep.</p>
<h3 id="key-events"><a class="header" href="#key-events">Key Events</a></h3>
<img width=300 style="padding: 20px;" src="assets/keyevent.png">
<p>Key events are passed down from the current focus to the root, with the
<strong>Node::handle_key</strong> method called on each node. Keys are only handled once - we
stop passing the event along once the first node indicates that it's been
handled. Handling a key event automatically taints the node, unless the
<strong>EventResult::no_render</strong> flag in the response object is true.</p>
<h3 id="mouse-events"><a class="header" href="#mouse-events">Mouse Events</a></h3>
<img width=300 style="padding: 20px;" src="assets/mouseevent.png">
<p>Mouse events are independent of the focus - we locate the leaf node that is
under the mouse cursor, then pass event through the path from the leaf to the
root for handling. For each node on the path, the <strong>Node::handle_mouse</strong> method
is called, and we stop after the first node handles the event. Handling a mouse
event taints the node, unless the <strong>EventResult::no_render</strong> flag on the
response object is true.</p>
<h3 id="actions"><a class="header" href="#actions">Actions</a></h3>
<h2 id="tick"><a class="header" href="#tick">Tick</a></h2>
<img width=300 style="padding: 20px;" src="assets/tick.png">
<p>The interval between tick events is specified when the event loop is started.
Tick events are propagated as a pre-order traversal from the root of the tree,
with the <strong>Node::handle_tick</strong> method called on each node. Because tick events
can fire many times a second - efficiency is quite important. A tick handler can
set the <strong>skip</strong> flag on its return value to signal that its children don't need
to recieve the tick event. In the diagram above, the grey node has done this, so
the traversal continues to a sibling.</p>
<p>Nodes that handle a tick event are automatically tainted.</p>
<h3 id="cursor-management"><a class="header" href="#cursor-management">Cursor management</a></h3>
<p>For historical reasons, terminals don't distinguish between the location of the
visible cursor and the draw location for rendering. Drawing with the cursor
turned on will result in a visible cursor moving over the screen. Canopy manages
this by turning cursors off during rendering, and then enabling the cursor
during a separate cursor sweep afterwards. The cursor sweep gives all nodes on
the focus path the opportunity to define a cursor location and style using the
<code>cursor</code> method on the Node trait.</p>
<div style="break-before: page; page-break-before: always;"></div><div style="break-before: page; page-break-before: always;"></div><div style="break-before: page; page-break-before: always;"></div><h1 id="layout"><a class="header" href="#layout">Layout</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="focus-1"><a class="header" href="#focus-1">Focus</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="polling"><a class="header" href="#polling">Polling</a></h1>
<div style="break-before: page; page-break-before: always;"></div><div style="break-before: page; page-break-before: always;"></div><div style="break-before: page; page-break-before: always;"></div><h1 id="widgets"><a class="header" href="#widgets">Widgets</a></h1>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
